{
    "prompts": [
        {
            "name": "argocdDomainName",
            "default": "argocd.example.com",
            "message": "Please enter the domain name you want argocd to be accessible on:",
            "type": "Input"
        },
        {
            "name": "mysqlDomainName",
            "default": "mysql.example.com",
            "message": "Please enter the domain name you want mysql to be accessible on:",
            "type": "Input"
        },
        {
            "message": "Please enter the email address you want to use for lets encrypt:",
            "default": "admin@example.com",
            "name": "letsEncryptClusterIssuerEmailAddress",
            "type": "Input"
        },
        {
            "message": "Please enter the username for your mysql admin:",
            "default": "admin",
            "name": "mysqlUser",
            "type": "Input"
        },
        {
            "message": "Please enter the mysql admin password ",
            "default": "password",
            "name": "mysqlPassword",
            "type": "Secret"
        },
        {
            "message": "Please enter the mysql root password ",
            "default": "password",
            "name": "mysqlRootPassword",
            "type": "Secret"
        }
    ],
    "outputs": {
        "cndi-config": {
            "cndi_version": "v1",
            "infrastructure": {
                "cndi": {
                    "nodes": [
                        {
                            "name": "x-mysql-node",
                            "kind": "ec2",
                            "role": "leader",
                            "instance_type": "m5a.large",
                            "volume_size": 128
                        },
                        {
                            "name": "y-mysql-node",
                            "kind": "ec2",
                            "volume_size": 128
                        },
                        {
                            "name": "z-mysql-node",
                            "kind": "ec2",
                            "volume_size": 128
                        }
                    ]
                },
                "terraform": {
                    "resource": {
                        "aws_lb_target_group": {
                            "cndi_aws_lb_target_group_mysql": {
                                "port": 3306,
                                "protocol": "TCP",
                                "vpc_id": "${aws_vpc.cndi_aws_vpc.id}",
                                "tags": {
                                    "Name": "MYSQLLBTargetGroup",
                                    "CNDIProject": "${local.cndi_project_name}"
                                }
                            }
                        },
                        "aws_lb_listener": {
                            "cndi_aws_lb_listener_mysql": {
                                "load_balancer_arn": "${aws_lb.cndi_aws_lb.arn}",
                                "port": 3306,
                                "protocol": "TCP",
                                "default_action": [
                                    {
                                        "type": "forward",
                                        "target_group_arn": "${aws_lb_target_group.cndi_aws_lb_target_group_mysql.arn}"
                                    }
                                ]
                            }
                        },
                        "aws_security_group": {
                            "cndi_aws_security_group": {
                                "ingress": [
                                    {
                                        "description": "Port for mysql traffic",
                                        "from_port": "3306",
                                        "to_port": "3306",
                                        "protocol": "tcp",
                                        "cidr_blocks": [
                                            "0.0.0.0/0"
                                        ],
                                        "ipv6_cidr_blocks": [],
                                        "prefix_list_ids": [],
                                        "security_groups": [],
                                        "self": false
                                    }
                                ]
                            }
                        },
                        "aws_lb_target_group_attachment": {
                            "cndi_aws_lb_target_group_attachment_mysql": {
                                "count": "${length(local.node_id_list)}",
                                "target_group_arn": "${aws_lb_target_group.cndi_aws_lb_target_group_mysql.arn}",
                                "target_id": "${local.node_id_list[count.index]}"
                            }
                        }
                    }
                }
            },
            "cluster_manifests": {
                "cert-manager-cluster-issuer": {
                    "apiVersion": "cert-manager.io/v1",
                    "kind": "ClusterIssuer",
                    "metadata": {
                        "name": "lets-encrypt"
                    },
                    "spec": {
                        "acme": {
                            "email": "{{ $.cndi.prompts.responses.letsEncryptClusterIssuerEmailAddress }}",
                            "server": "https://acme-v02.api.letsencrypt.org/directory",
                            "privateKeySecretRef": {
                                "name": "lets-encrypt-private-key"
                            },
                            "solvers": [
                                {
                                    "http01": {
                                        "ingress": {
                                            "class": "public"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                },
                "argo-ingress": {
                    "apiVersion": "networking.k8s.io/v1",
                    "kind": "Ingress",
                    "metadata": {
                        "name": "argocd-server-ingress",
                        "namespace": "argocd",
                        "annotations": {
                            "cert-manager.io/cluster-issuer": "lets-encrypt",
                            "kubernetes.io/tls-acme": "true",
                            "nginx.ingress.kubernetes.io/ssl-passthrough": "true",
                            "nginx.ingress.kubernetes.io/backend-protocol": "HTTPS"
                        }
                    },
                    "spec": {
                        "tls": [
                            {
                                "hosts": [
                                    "{{ $.cndi.prompts.responses.argocdDomainName }}"
                                ],
                                "secretName": "lets-encrypt-private-key"
                            }
                        ],
                        "rules": [
                            {
                                "host": "{{ $.cndi.prompts.responses.argocdDomainName }}",
                                "http": {
                                    "paths": [
                                        {
                                            "path": "/",
                                            "pathType": "Prefix",
                                            "backend": {
                                                "service": {
                                                    "name": "argocd-server",
                                                    "port": {
                                                        "name": "https"
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                "mysql-admin-secret": {
                    "apiVersion": "v1",
                    "kind": "Secret",
                    "metadata": {
                        "name": "mysql-secret",
                        "namespace": "mysql"
                    },
                    "type": "kubernetes.io/basic-auth",
                    "stringData": {
                        "username": "$.cndi.secrets.seal(USERNAME)",
                        "mysql-password": "$.cndi.secrets.seal(USERPASSWORD)",
                        "mysql-root-password": "$.cndi.secrets.seal(ROOTPASSWORD)"
                    }
                },
                "mysql-ingress": {
                    "apiVersion": "networking.k8s.io/v1",
                    "kind": "Ingress",
                    "metadata": {
                        "name": "mysql-ingress",
                        "namespace": "mysql",
                        "annotations": {
                            "cert-manager.io/cluster-issuer": "lets-encrypt",
                            "kubernetes.io/tls-acme": "true"
                        }
                    },
                    "spec": {
                        "tls": [
                            {
                                "hosts": [
                                    "{{ $.cndi.prompts.responses.mysqlDomainName }}"
                                ],
                                "secretName": "lets-encrypt-private-key"
                            }
                        ],
                        "rules": [
                            {
                                "host": "{{ $.cndi.prompts.responses.mysqlDomainName }}",
                                "http": {
                                    "paths": [
                                        {
                                            "path": "/",
                                            "pathType": "Prefix",
                                            "backend": {
                                                "service": {
                                                    "name": "mysql",
                                                    "port": {
                                                        "number": 3306
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                "mysql-configmap": {
                    "apiVersion": "v1",
                    "kind": "ConfigMap",
                    "metadata": {
                        "name": "nginx-ingress-tcp-microk8s-conf",
                        "namespace": "ingress"
                    },
                    "data": {
                        "3306": "mysql/mysql:3306"
                    }
                },
                "mysql-configmap-daemon": {
                    "apiVersion": "apps/v1",
                    "kind": "DaemonSet",
                    "metadata": {
                        "name": "nginx-ingress-microk8s-controller",
                        "namespace": "ingress"
                    },
                    "spec": {
                        "selector": {
                            "matchLabels": {
                                "name": "nginx-ingress-microk8s"
                            }
                        },
                        "template": {
                            "metadata": {
                                "labels": {
                                    "name": "nginx-ingress-microk8s"
                                }
                            },
                            "spec": {
                                "containers": [
                                    {
                                        "name": "mysql-server",
                                        "image": "registry.k8s.io/ingress-nginx/controller:v1.5.1",
                                        "env": [
                                            {
                                                "name": "POD_NAME",
                                                "valueFrom": {
                                                    "fieldRef": {
                                                        "fieldPath": "metadata.name"
                                                    }
                                                }
                                            },
                                            {
                                                "name": "POD_NAMESPACE",
                                                "valueFrom": {
                                                    "fieldRef": {
                                                        "fieldPath": "metadata.namespace"
                                                    }
                                                }
                                            }
                                        ],
                                        "ports": [
                                            {
                                                "name": "http",
                                                "containerPort": 80,
                                                "hostPort": 80
                                            },
                                            {
                                                "name": "https",
                                                "containerPort": 443,
                                                "hostPort": 443
                                            },
                                            {
                                                "name": "tcp-3306",
                                                "containerPort": 3306,
                                                "hostPort": 3306,
                                                "protocol": "TCP"
                                            }
                                        ],
                                        "args": [
                                            "/nginx-ingress-controller",
                                            "--tcp-services-configmap=$(POD_NAMESPACE)/nginx-ingress-tcp-microk8s-conf",
                                            "--ingress-class=public"
                                        ]
                                    }
                                ]
                            }
                        }
                    }
                }
            },
            "applications": {
                "mysql": {
                    "targetRevision": "9.9.1",
                    "repoURL": "https://charts.bitnami.com/bitnami",
                    "destinationNamespace": "mysql",
                    "chart": "mysql",
                    "values": {
                        "auth": {
                            "existingSecret": "mysql-secret"
                        }
                    }
                }
            }
        },
        "env": {
            "extend_basic_env": "aws",
            "entries": [
                {
                    "name": "USERNAME",
                    "value": "{{ $.cndi.prompts.responses.mysqlUser }}"
                },
                {
                    "name": "USERPASSWORD",
                    "value": "{{ $.cndi.prompts.responses.mysqlPassword }}"
                },
                {
                    "name": "ROOTPASSWORD",
                    "value": "{{ $.cndi.prompts.responses.mysqlRootPassword }}"
                }
            ]
        },
        "readme": {
            "extend_basic_readme": "aws",
            "template_section": "## mysql \n\n This template deploys a Standalone mysql server using bitnami helm chart [https://charts.bitnami.com/bitnami]"
        }
    }
}