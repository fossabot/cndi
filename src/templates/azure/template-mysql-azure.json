{
    "prompts": [
        {
            "name": "argocdDomainName",
            "default": "argocd.example.com",
            "message": "Please enter the domain name you want argocd to be accessible on:",
            "type": "Input"
        },
        {
            "name": "mysqlDomainName",
            "default": "mysql.example.com",
            "message": "Please enter the domain name you want mysql to be accessible on:",
            "type": "Input"
        },
        {
            "message": "Please enter the email address you want to use for lets encrypt:",
            "default": "admin@example.com",
            "name": "letsEncryptClusterIssuerEmailAddress",
            "type": "Input"
        },
        {
            "message": "Please enter the username for your mysql admin:",
            "default": "admin",
            "name": "mysqlUser",
            "type": "Input"
        },
        {
            "message": "Please enter the mysql admin password ",
            "default": "password",
            "name": "mysqlPassword",
            "type": "Secret"
        },
        {
            "message": "Please enter the mysql root password ",
            "default": "password",
            "name": "mysqlRootPassword",
            "type": "Secret"
        }
    ],
    "outputs": {
        "cndi-config": {
            "cndi_version": "v1",
            "infrastructure": {
                "cndi": {
                    "nodes": [
                        {
                            "name": "x-mysql-node",
                            "kind": "ec2",
                            "role": "leader",
                            "instance_type": "m5a.large",
                            "volume_size": 128
                        },
                        {
                            "name": "y-mysql-node",
                            "kind": "ec2",
                            "volume_size": 128
                        },
                        {
                            "name": "z-mysql-node",
                            "kind": "ec2",
                            "volume_size": 128
                        }
                    ]
                },
                "terraform": {
                    "resource": {
                        "azurerm_lb_probe": {
                            "cndi_azurerm_lb_probe_mysql": {
                                "loadbalancer_id": "${azurerm_lb.cndi_azurerm_lb.id}",
                                "name": "cndi_load_balancer_mysql_health_probe",
                                "port": 3306
                            }
                        },
                        "azurerm_lb_rule": {
                            "cndi_azurerm_lb_rule_mysql": {
                                "backend_address_pool_ids": [
                                    "${azurerm_lb_backend_address_pool.cndi_azurerm_lb_backend_address_pool.id}"
                                ],
                                "backend_port": 3306,
                                "frontend_ip_configuration_name": "cndi_azurerm_lb_frontend_ip_configuration",
                                "frontend_port": 3306,
                                "loadbalancer_id": "${azurerm_lb.cndi_azurerm_lb.id}",
                                "name": "mysql",
                                "probe_id": "${azurerm_lb_probe.cndi_azurerm_lb_probe_mysql.id}",
                                "protocol": "Tcp"
                            }
                        },
                        "azurerm_network_security_group": {
                            "cndi_azurerm_network_security_group": {
                                "location": "${azurerm_resource_group.cndi_azurerm_resource_group.location}",
                                "name": "cndi_azurerm_network_security_group",
                                "resource_group_name": "${azurerm_resource_group.cndi_azurerm_resource_group.name}",
                                "security_rule": [
                                    {
                                        "access": "Allow",
                                        "description": "Allow inbound for mysql traffic",
                                        "destination_address_prefix": "*",
                                        "destination_address_prefixes": [],
                                        "destination_application_security_group_ids": [],
                                        "destination_port_range": "3306",
                                        "destination_port_ranges": [],
                                        "direction": "Inbound",
                                        "name": "Allowmysql",
                                        "priority": 250,
                                        "protocol": "Tcp",
                                        "source_address_prefix": "*",
                                        "source_address_prefixes": [],
                                        "source_application_security_group_ids": [],
                                        "source_port_range": "*",
                                        "source_port_ranges": []
                                    }
                                ],
                                "tags": {
                                    "CNDIProject": "${local.cndi_project_name}"
                                }
                            }
                        }
                    }
                }
            },
            "cluster_manifests": {
                "cert-manager-cluster-issuer": {
                    "apiVersion": "cert-manager.io/v1",
                    "kind": "ClusterIssuer",
                    "metadata": {
                        "name": "lets-encrypt"
                    },
                    "spec": {
                        "acme": {
                            "email": "{{ $.cndi.prompts.responses.letsEncryptClusterIssuerEmailAddress }}",
                            "server": "https://acme-v02.api.letsencrypt.org/directory",
                            "privateKeySecretRef": {
                                "name": "lets-encrypt-private-key"
                            },
                            "solvers": [
                                {
                                    "http01": {
                                        "ingress": {
                                            "class": "public"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                },
                "argo-ingress": {
                    "apiVersion": "networking.k8s.io/v1",
                    "kind": "Ingress",
                    "metadata": {
                        "name": "argocd-server-ingress",
                        "namespace": "argocd",
                        "annotations": {
                            "cert-manager.io/cluster-issuer": "lets-encrypt",
                            "kubernetes.io/tls-acme": "true",
                            "nginx.ingress.kubernetes.io/ssl-passthrough": "true",
                            "nginx.ingress.kubernetes.io/backend-protocol": "HTTPS"
                        }
                    },
                    "spec": {
                        "tls": [
                            {
                                "hosts": [
                                    "{{ $.cndi.prompts.responses.argocdDomainName }}"
                                ],
                                "secretName": "lets-encrypt-private-key"
                            }
                        ],
                        "rules": [
                            {
                                "host": "{{ $.cndi.prompts.responses.argocdDomainName }}",
                                "http": {
                                    "paths": [
                                        {
                                            "path": "/",
                                            "pathType": "Prefix",
                                            "backend": {
                                                "service": {
                                                    "name": "argocd-server",
                                                    "port": {
                                                        "name": "https"
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                "mysql-admin-secret": {
                    "apiVersion": "v1",
                    "kind": "Secret",
                    "metadata": {
                        "name": "mysql-secret",
                        "namespace": "mysql"
                    },
                    "type": "kubernetes.io/basic-auth",
                    "stringData": {
                        "username": "$.cndi.secrets.seal(USERNAME)",
                        "mysql-password": "$.cndi.secrets.seal(USERPASSWORD)",
                        "mysql-root-password": "$.cndi.secrets.seal(ROOTPASSWORD)"
                    }
                },
                "mysql-ingress": {
                    "apiVersion": "networking.k8s.io/v1",
                    "kind": "Ingress",
                    "metadata": {
                        "name": "mysql-ingress",
                        "namespace": "mysql",
                        "annotations": {
                            "cert-manager.io/cluster-issuer": "lets-encrypt",
                            "kubernetes.io/tls-acme": "true"
                        }
                    },
                    "spec": {
                        "tls": [
                            {
                                "hosts": [
                                    "{{ $.cndi.prompts.responses.mysqlDomainName }}"
                                ],
                                "secretName": "lets-encrypt-private-key"
                            }
                        ],
                        "rules": [
                            {
                                "host": "{{ $.cndi.prompts.responses.mysqlDomainName }}",
                                "http": {
                                    "paths": [
                                        {
                                            "path": "/",
                                            "pathType": "Prefix",
                                            "backend": {
                                                "service": {
                                                    "name": "mysql",
                                                    "port": {
                                                        "number": 3306
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                "mysql-configmap": {
                    "apiVersion": "v1",
                    "kind": "ConfigMap",
                    "metadata": {
                        "name": "nginx-ingress-tcp-microk8s-conf",
                        "namespace": "ingress"
                    },
                    "data": {
                        "3306": "mysql/mysql:3306"
                    }
                },
                "mysql-configmap-daemon": {
                    "apiVersion": "apps/v1",
                    "kind": "DaemonSet",
                    "metadata": {
                        "name": "nginx-ingress-microk8s-controller",
                        "namespace": "ingress"
                    },
                    "spec": {
                        "selector": {
                            "matchLabels": {
                                "name": "nginx-ingress-microk8s"
                            }
                        },
                        "template": {
                            "metadata": {
                                "labels": {
                                    "name": "nginx-ingress-microk8s"
                                }
                            },
                            "spec": {
                                "containers": [
                                    {
                                        "name": "mysql-server",
                                        "image": "registry.k8s.io/ingress-nginx/controller:v1.5.1",
                                        "env": [
                                            {
                                                "name": "POD_NAME",
                                                "valueFrom": {
                                                    "fieldRef": {
                                                        "fieldPath": "metadata.name"
                                                    }
                                                }
                                            },
                                            {
                                                "name": "POD_NAMESPACE",
                                                "valueFrom": {
                                                    "fieldRef": {
                                                        "fieldPath": "metadata.namespace"
                                                    }
                                                }
                                            }
                                        ],
                                        "ports": [
                                            {
                                                "name": "http",
                                                "containerPort": 80,
                                                "hostPort": 80
                                            },
                                            {
                                                "name": "https",
                                                "containerPort": 443,
                                                "hostPort": 443
                                            },
                                            {
                                                "name": "tcp-3306",
                                                "containerPort": 3306,
                                                "hostPort": 3306,
                                                "protocol": "TCP"
                                            }
                                        ],
                                        "args": [
                                            "/nginx-ingress-controller",
                                            "--tcp-services-configmap=$(POD_NAMESPACE)/nginx-ingress-tcp-microk8s-conf",
                                            "--ingress-class=public"
                                        ]
                                    }
                                ]
                            }
                        }
                    }
                }
            },
            "applications": {
                "mysql": {
                    "targetRevision": "9.9.1",
                    "repoURL": "https://charts.bitnami.com/bitnami",
                    "destinationNamespace": "mysql",
                    "chart": "mysql",
                    "values": {
                        "auth": {
                            "existingSecret": "mysql-secret"
                        }
                    }
                }
            }
        },
        "env": {
            "extend_basic_env": "aws",
            "entries": [
                {
                    "name": "USERNAME",
                    "value": "{{ $.cndi.prompts.responses.mysqlUser }}"
                },
                {
                    "name": "USERPASSWORD",
                    "value": "{{ $.cndi.prompts.responses.mysqlPassword }}"
                },
                {
                    "name": "ROOTPASSWORD",
                    "value": "{{ $.cndi.prompts.responses.mysqlRootPassword }}"
                }
            ]
        },
        "readme": {
            "extend_basic_readme": "azure",
            "template_section": "## mysql \n\n This template deploys a Standalone mysql server using bitnami helm chart [https://charts.bitnami.com/bitnami]"
        }
    }
}