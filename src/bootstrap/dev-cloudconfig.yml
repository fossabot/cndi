#cloud-config

# run commands
# default: none
# runcmd contains a list of either lists or a string
# each item will be executed in order at rc.local like level with
# output to the console
# - runcmd only runs during the first boot
# - if the item is a list, the items will be properly executed as if
#   passed to execve(3) (with the first arg as the command).
# - if the item is a string, it will be simply written to the file and
#   will be interpreted by 'sh'
#
# Note, that the list has to be proper yaml, so you have to quote
# any characters yaml would eat (':' can be problematic)
package_update: true

packages:
  - apache2-utils
  - nfs-common

users:
  - name: ubuntu
    groups: microk8s

runcmd:
  - [sh, -c, "echo 'installing microk8s'"]
  - [sh, -c, "sudo snap install microk8s --classic --channel=1.26/stable"]
  - [sh, -c, "granting ownership of kube config to ubuntu user"]
  - [sh, -c, "sudo chown -f -R ubuntu ~/.kube"]
  - [sh, -c, "echo 'awaiting microk8s status"]
  - [sh, -c, "sudo microk8s status --wait-ready"]
  - [sh, -c, "microk8s ready'"]
  - [sh, -c, "echo 'enabling microk8s addons'"]
  - [sh, -c, "sudo microk8s enable dns:1.1.1.1 ingress commmunity nfs cert-manager"]
  - [sh, -c, "echo 'all addons enabled'"]

  - [sh, -c, echo "=========hello world========="]
  - ls -l /root
  # Note: Don't write files to /tmp from cloud-init use /run/somedir instead.
  # Early boot environments can race systemd-tmpfiles-clean LP: #1707222.
  - mkdir /run/mydir
  - [wget, "http://slashdot.org", -O, /run/mydir/index.html]
